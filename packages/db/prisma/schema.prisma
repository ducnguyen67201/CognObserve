generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================================
// Authentication Models (NextAuth.js / Auth.js)
// ============================================================

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  password      String?
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts       Account[]
  sessions       Session[]
  projects       ProjectMember[]
  workspaces     WorkspaceMember[]
  domainsCreated AllowedDomain[] @relation("DomainCreatedBy")

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================================
// Workspace Models
// ============================================================

enum WorkspaceRole {
  OWNER
  ADMIN
  MEMBER
}

model Workspace {
  id         String   @id @default(cuid())
  name       String
  slug       String   @unique
  isPersonal Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  members              WorkspaceMember[]
  projects             Project[]
  allowedDomains       AllowedDomain[]
  notificationChannels NotificationChannel[]

  @@index([slug])
  @@map("workspaces")
}

model WorkspaceMember {
  id          String        @id @default(cuid())
  userId      String
  workspaceId String
  role        WorkspaceRole @default(MEMBER)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([userId, workspaceId])
  @@index([workspaceId])
  @@map("workspace_members")
}

// ============================================================
// Domain Matcher Model (Auto-Join by Email Domain)
// ============================================================

model AllowedDomain {
  id          String        @id @default(cuid())
  workspaceId String
  domain      String        @unique // e.g., "acme.com" - globally unique
  role        WorkspaceRole @default(MEMBER)
  createdById String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  createdBy User      @relation("DomainCreatedBy", fields: [createdById], references: [id])

  @@index([domain])
  @@index([workspaceId])
  @@map("allowed_domains")
}

// ============================================================
// Project & Membership Models
// ============================================================

enum ProjectRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

model Project {
  id          String   @id @default(cuid())
  name        String
  workspaceId String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace    Workspace          @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  apiKeys      ApiKey[]
  traces       Trace[]
  members      ProjectMember[]
  costSummary  CostDailySummary[]
  alerts       Alert[]

  @@index([workspaceId])
}

model ProjectMember {
  id        String      @id @default(cuid())
  userId    String
  projectId String
  role      ProjectRole @default(MEMBER)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([userId, projectId])
  @@map("project_members")
}

model ApiKey {
  id          String    @id @default(cuid())
  projectId   String
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  name        String    @default("Default")
  hashedKey   String    @unique
  displayKey  String
  createdById String?
  createdAt   DateTime  @default(now())
  lastUsedAt  DateTime?
  expiresAt   DateTime?

  @@index([projectId])
  @@index([hashedKey])
}

model Trace {
  id        String   @id @default(cuid())
  projectId String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  name      String
  timestamp DateTime @default(now())
  metadata  Json?

  spans Span[]

  @@index([projectId, timestamp(sort: Desc)])
  @@index([projectId, id])
  @@index([projectId])
  @@index([timestamp])
}

model Span {
  id               String        @id @default(cuid())
  traceId          String
  trace            Trace         @relation(fields: [traceId], references: [id], onDelete: Cascade)
  parentSpanId     String?
  name             String
  startTime        DateTime
  endTime          DateTime?
  input            Json?
  output           Json?
  metadata         Json?
  model            String?
  modelParameters  Json?
  promptTokens     Int?
  completionTokens Int?
  totalTokens      Int?
  level            SpanLevel     @default(DEFAULT)
  statusMessage    String?

  // Cost tracking fields
  inputCost        Decimal?      @db.Decimal(10, 6)
  outputCost       Decimal?      @db.Decimal(10, 6)
  totalCost        Decimal?      @db.Decimal(10, 6)
  pricingId        String?
  pricing          ModelPricing? @relation(fields: [pricingId], references: [id])

  @@index([traceId, startTime])
  @@index([traceId])
  @@index([parentSpanId])
  @@index([startTime])
  @@index([pricingId])
}

enum SpanLevel {
  DEBUG
  DEFAULT
  WARNING
  ERROR
}

// ============================================================
// Cost Tracking Models
// ============================================================

model ModelPricing {
  id                    String    @id @default(cuid())
  provider              String    // openai, anthropic, google, mistral
  model                 String    // gpt-4o, claude-3-5-sonnet, etc
  displayName           String    // Human-readable name
  inputPricePerMillion  Decimal   @db.Decimal(10, 6)
  outputPricePerMillion Decimal   @db.Decimal(10, 6)
  effectiveFrom         DateTime  @default(now())
  effectiveTo           DateTime? // null = current price
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  spans Span[]

  @@unique([provider, model, effectiveFrom])
  @@index([provider, model])
  @@map("model_pricing")
}

model CostDailySummary {
  id           String   @id @default(cuid())
  projectId    String
  project      Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  date         DateTime @db.Date
  model        String   // model name or "__all__" for project total
  spanCount    Int      @default(0)
  inputTokens  BigInt   @default(0)
  outputTokens BigInt   @default(0)
  totalTokens  BigInt   @default(0)
  inputCost    Decimal  @default(0) @db.Decimal(12, 6)
  outputCost   Decimal  @default(0) @db.Decimal(12, 6)
  totalCost    Decimal  @default(0) @db.Decimal(12, 6)
  updatedAt    DateTime @updatedAt

  @@unique([projectId, date, model])
  @@index([projectId, date])
  @@map("cost_daily_summary")
}

// ============================================================
// Alerting Models
// ============================================================

enum AlertType {
  ERROR_RATE
  LATENCY_P50
  LATENCY_P95
  LATENCY_P99
}

enum AlertOperator {
  GREATER_THAN
  LESS_THAN
}

enum ChannelProvider {
  GMAIL
  DISCORD
  SLACK
  PAGERDUTY
  WEBHOOK
}

enum AlertSeverity {
  CRITICAL // P1 - System down, data loss
  HIGH     // P2 - Service degradation
  MEDIUM   // P3 - Performance issues
  LOW      // P4 - Warnings, capacity
}

enum AlertState {
  INACTIVE // Condition not met
  PENDING  // Condition met, waiting for pendingDuration
  FIRING   // Alert triggered, notifications sent
  RESOLVED // Was firing, now recovered
}

model Alert {
  id              String             @id @default(cuid())
  projectId       String
  project         Project            @relation(fields: [projectId], references: [id], onDelete: Cascade)
  name            String
  type            AlertType
  threshold       Float
  operator        AlertOperator      @default(GREATER_THAN)
  windowMins      Int                @default(5)
  cooldownMins    Int                @default(60)
  enabled         Boolean            @default(true)
  lastTriggeredAt DateTime?

  // Severity-based configuration
  severity        AlertSeverity      @default(MEDIUM)

  // Timing configuration (pendingMins = condition must persist before firing)
  pendingMins     Int                @default(2)

  // State tracking
  state           AlertState         @default(INACTIVE)
  stateChangedAt  DateTime?
  lastEvaluatedAt DateTime?

  channels        AlertChannel[]     // Legacy - to be deprecated
  channelLinks    AlertChannelLink[] // New - links to workspace channels
  history         AlertHistory[]
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  @@index([projectId])
  @@index([enabled, lastTriggeredAt])
  @@index([enabled, severity])
  @@index([state, enabled])
  @@map("alerts")
}

model AlertChannel {
  id        String          @id @default(cuid())
  alertId   String
  alert     Alert           @relation(fields: [alertId], references: [id], onDelete: Cascade)
  provider  ChannelProvider
  config    Json
  verified  Boolean         @default(false)
  createdAt DateTime        @default(now())

  @@index([alertId])
  @@map("alert_channels")
}

model AlertHistory {
  id          String       @id @default(cuid())
  alertId     String
  alert       Alert        @relation(fields: [alertId], references: [id], onDelete: Cascade)
  triggeredAt DateTime     @default(now())
  value       Float
  threshold   Float
  resolved    Boolean      @default(false)
  resolvedAt  DateTime?
  notifiedVia String[]

  // State tracking
  state         AlertState?
  previousState AlertState?

  // Evaluation metadata
  sampleCount  Int?
  evaluationMs Int?

  @@index([alertId, triggeredAt])
  @@index([triggeredAt])
  @@map("alert_history")
}

// ============================================================
// Notification Channels (Workspace-level)
// ============================================================

model NotificationChannel {
  id          String          @id @default(cuid())
  workspaceId String
  workspace   Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  name        String          // User-friendly name: "Engineering Discord", "On-call Email"
  provider    ChannelProvider
  config      Json            // Provider-specific config (webhookUrl, email, etc.)
  verified    Boolean         @default(false)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  alertLinks AlertChannelLink[]

  @@unique([workspaceId, name])
  @@index([workspaceId])
  @@map("notification_channels")
}

model AlertChannelLink {
  id        String              @id @default(cuid())
  alertId   String
  alert     Alert               @relation(fields: [alertId], references: [id], onDelete: Cascade)
  channelId String
  channel   NotificationChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)
  createdAt DateTime            @default(now())

  @@unique([alertId, channelId])
  @@index([alertId])
  @@index([channelId])
  @@map("alert_channel_links")
}
