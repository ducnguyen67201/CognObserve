# Dockerfile.quickstart
#
# CognObserve Quick Start - Everything in one container
# Includes: PostgreSQL, Redis, Temporal (dev), Web, Ingest
#
# NOTE: Worker not included. Traces are queued but alerts/background
# processing requires running the worker separately.
# See docs/self-hosting for full setup.
#
# Usage:
#   docker build -f Dockerfile.quickstart -t cognobserve:latest .
#   docker run -d -p 3000:3000 -p 8080:8080 -v cognobserve_data:/data cognobserve:latest

# ============================================================
# Stage 1: Build Node.js Applications
# ============================================================
FROM node:24-alpine AS node-builder

RUN apk add --no-cache python3 make g++
RUN corepack enable && corepack prepare pnpm@9.15.0 --activate

WORKDIR /app

# Copy package files for dependency installation
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml turbo.json ./
COPY apps/web/package.json ./apps/web/
COPY apps/worker/package.json ./apps/worker/
COPY packages/db/package.json ./packages/db/
COPY packages/db/prisma ./packages/db/prisma/
COPY packages/api/package.json ./packages/api/
COPY packages/shared/package.json ./packages/shared/
COPY packages/proto/package.json ./packages/proto/
COPY packages/config-eslint/package.json ./packages/config-eslint/
COPY packages/config-typescript/package.json ./packages/config-typescript/

# Install dependencies
RUN pnpm install --frozen-lockfile

# Copy source code
COPY . .

# Generate Prisma client
RUN pnpm --filter @cognobserve/db db:generate

# Build shared packages
RUN pnpm --filter @cognobserve/shared build

# Build Web (Next.js with standalone output)
# Skip env validation during build - actual values are provided at runtime
ENV SKIP_ENV_VALIDATION=true
ENV DATABASE_URL="postgresql://placeholder:placeholder@localhost:5432/placeholder"

RUN pnpm --filter @cognobserve/web build

# ============================================================
# Stage 2: Get Temporal CLI (for dev server)
# ============================================================
FROM temporalio/admin-tools:latest AS temporal-tools

# ============================================================
# Stage 3: Build Go Ingest Service
# ============================================================
FROM golang:1.23-alpine AS go-builder

WORKDIR /app

# Copy Go module files
COPY apps/ingest/go.mod apps/ingest/go.sum ./

# Download dependencies
RUN go mod download

# Copy Go source
COPY apps/ingest/ ./

# Build static binary
RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o /ingest ./cmd/ingest

# ============================================================
# Stage 4: Production Runtime (All-in-One)
# ============================================================
FROM node:24-alpine AS runtime

# Install all required services and tools
RUN apk add --no-cache \
    # PostgreSQL
    postgresql16 \
    postgresql16-contrib \
    postgresql16-client \
    # Redis
    redis \
    # Process manager
    supervisor \
    # Utilities
    bash \
    curl \
    wget \
    openssl \
    netcat-openbsd \
    ca-certificates \
    tzdata \
    # gcompat needed for Temporal CLI
    gcompat

# Install Prisma CLI globally (avoids pnpm ESM issues)
RUN npm install -g prisma@7

# Create users
RUN addgroup -S cognobserve && adduser -S cognobserve -G cognobserve

# Setup PostgreSQL
ENV PGDATA=/data/postgresql
RUN mkdir -p /data/postgresql /run/postgresql \
    && chown -R postgres:postgres /data/postgresql /run/postgresql

# Setup Redis
RUN mkdir -p /data/redis \
    && chown -R redis:redis /data/redis

# Setup Temporal data directory
RUN mkdir -p /data/temporal

# Copy Node.js application
WORKDIR /app
# Copy root package files for monorepo resolution
COPY --from=node-builder /app/package.json ./package.json
COPY --from=node-builder /app/pnpm-workspace.yaml ./pnpm-workspace.yaml
# Copy Next.js standalone output
COPY --from=node-builder /app/apps/web/.next/standalone ./
COPY --from=node-builder /app/apps/web/.next/static ./apps/web/.next/static
# Copy public directory (contains static assets like favicon, images)
COPY --from=node-builder /app/apps/web/public ./apps/web/public
# Copy node_modules and packages for runtime
COPY --from=node-builder /app/node_modules ./node_modules
COPY --from=node-builder /app/packages ./packages

# Copy Go binary
COPY --from=go-builder /ingest ./ingest

# Copy Temporal CLI
COPY --from=temporal-tools /usr/local/bin/temporal /usr/local/bin/temporal

# Fix workspace package resolution for production runtime
# Update shared package.json to point to dist instead of src
RUN sed -i 's|"./src/index.ts"|"./dist/index.js"|g' /app/packages/shared/package.json

# Create symlinks in node_modules for workspace packages
RUN mkdir -p /app/node_modules/@cognobserve \
    && ln -sf /app/packages/shared /app/node_modules/@cognobserve/shared \
    && ln -sf /app/packages/api /app/node_modules/@cognobserve/api \
    && ln -sf /app/packages/db /app/node_modules/@cognobserve/db \
    && ln -sf /app/packages/proto /app/node_modules/@cognobserve/proto

# Copy configuration files
COPY docker/quickstart/supervisord.conf /etc/supervisord.conf
COPY docker/quickstart/entrypoint.sh /entrypoint.sh

RUN chmod +x /entrypoint.sh

# Create data directories
RUN mkdir -p /data/secrets /app/logs \
    && chown -R cognobserve:cognobserve /app /data/secrets /app/logs

# Expose ports
# 3000 - Web Dashboard & API
# 8080 - Ingest API (for SDKs)
EXPOSE 3000 8080

# Health check - use ingest service (no auth required)
HEALTHCHECK --interval=30s --timeout=10s --start-period=120s --retries=3 \
    CMD wget -qO- http://localhost:8080/health || exit 1

# Volume for persistent data
VOLUME ["/data"]

ENTRYPOINT ["/entrypoint.sh"]
