# docker-compose.self-hosted.yml
#
# CognObserve Self-Hosted Production Deployment
#
# Quick Start:
#   export NEXTAUTH_SECRET=$(openssl rand -base64 32)
#   export NEXTAUTH_URL="http://localhost:3000"
#   docker compose -f docker-compose.self-hosted.yml up -d
#
# With Temporal UI (for debugging):
#   docker compose -f docker-compose.self-hosted.yml --profile debug up -d
#
# Documentation: https://github.com/cognobserve/cognobserve

name: cognobserve

services:
  # ============================================================
  # PostgreSQL Database
  # ============================================================
  postgres:
    image: postgres:16-alpine
    container_name: cognobserve-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: cognobserve
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-cognobserve}
      POSTGRES_DB: cognobserve
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U cognobserve"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - cognobserve-internal
    # Uncomment to expose PostgreSQL externally
    # ports:
    #   - "5432:5432"

  # ============================================================
  # Redis Cache
  # ============================================================
  redis:
    image: redis:7-alpine
    container_name: cognobserve-redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - cognobserve-internal
    # Uncomment to expose Redis externally
    # ports:
    #   - "6379:6379"

  # ============================================================
  # Temporal Server (Workflow Orchestration)
  # ============================================================
  temporal:
    image: temporalio/auto-setup:latest
    container_name: cognobserve-temporal
    restart: unless-stopped
    environment:
      - DB=postgresql
      - DB_PORT=5432
      - POSTGRES_USER=cognobserve
      - POSTGRES_PWD=${POSTGRES_PASSWORD:-cognobserve}
      - POSTGRES_SEEDS=postgres
      - DYNAMIC_CONFIG_FILE_PATH=config/dynamicconfig/development.yaml
      - SKIP_DEFAULT_NAMESPACE_CREATION=false
    volumes:
      - ./temporal-config:/etc/temporal/config/dynamicconfig:ro
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "tctl", "--address", "temporal:7233", "cluster", "health"]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 40s
    networks:
      - cognobserve-internal

  # ============================================================
  # Temporal UI (Optional - for debugging)
  # ============================================================
  temporal-ui:
    image: temporalio/ui:latest
    container_name: cognobserve-temporal-ui
    restart: unless-stopped
    environment:
      - TEMPORAL_ADDRESS=temporal:7233
      - TEMPORAL_CORS_ORIGINS=http://localhost:3000,${NEXTAUTH_URL:-http://localhost:3000}
    ports:
      - "8088:8080"
    depends_on:
      temporal:
        condition: service_healthy
    networks:
      - cognobserve-internal
    profiles:
      - debug

  # ============================================================
  # CognObserve Application (Web + Worker + Ingest)
  # ============================================================
  app:
    image: ghcr.io/cognobserve/cognobserve-app:${VERSION:-latest}
    build:
      context: .
      dockerfile: Dockerfile.app
    container_name: cognobserve-app
    restart: unless-stopped
    ports:
      - "${WEB_PORT:-3000}:3000"
      - "${INGEST_PORT:-8080}:8080"
    environment:
      # Required - Must be set by user
      NEXTAUTH_SECRET: ${NEXTAUTH_SECRET:?NEXTAUTH_SECRET is required. Generate with: openssl rand -base64 32}
      NEXTAUTH_URL: ${NEXTAUTH_URL:-http://localhost:3000}

      # Database (auto-configured for bundled services)
      DATABASE_URL: postgresql://cognobserve:${POSTGRES_PASSWORD:-cognobserve}@postgres:5432/cognobserve
      REDIS_URL: redis://redis:6379

      # Temporal
      TEMPORAL_ADDRESS: temporal:7233
      TEMPORAL_NAMESPACE: default
      TEMPORAL_TASK_QUEUE: cognobserve-tasks

      # Internal (auto-generated if not set)
      INTERNAL_API_SECRET: ${INTERNAL_API_SECRET:-}
      JWT_SHARED_SECRET: ${JWT_SHARED_SECRET:-}
      WEB_API_URL: http://localhost:3000

      # Optional configuration
      NODE_ENV: production
      LOG_LEVEL: ${LOG_LEVEL:-info}
      RETENTION_DAYS: ${RETENTION_DAYS:-30}
      ENABLE_REGISTRATION: ${ENABLE_REGISTRATION:-true}
    volumes:
      - app_secrets:/app/secrets
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      temporal:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - cognobserve-internal

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  app_secrets:
    driver: local

networks:
  cognobserve-internal:
    driver: bridge
